name: Upload Python Package

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, windows-latest, macos-latest]

    steps:
    - uses: actions/checkout@v4
    
    - name: Install system dependencies (Linux)
      if: matrix.os == 'ubuntu-22.04'
      run: |
        sudo apt-get update
        # Install comprehensive list of dependencies for CEF (Chrome 66 / GTK2)
        sudo apt-get install -y \
          libgtk2.0-dev \
          libnss3-dev \
          libgconf-2-4 \
          libasound2-dev \
          libxss-dev \
          libxtst-dev \
          libx11-dev \
          libxcomposite-dev \
          libxcursor-dev \
          libxdamage-dev \
          libxi-dev \
          libxrandr-dev \
          libcups2-dev \
          libatk1.0-dev
          
    - name: Debug Linux Environment
      if: matrix.os == 'ubuntu-22.04'
      run: |
        echo "Checking pkg-config..."
        which pkg-config || echo "pkg-config not found"
        pkg-config --modversion gtk+-2.0 || echo "gtk+-2.0 info failed"
        pkg-config --cflags gtk+-2.0 || echo "gtk+-2.0 cflags failed"
        ls -d /usr/include/gtk-2.0 || echo "/usr/include/gtk-2.0 not found"

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r tools/requirements.txt
        
    - name: Download CEF Binaries
      shell: bash
      run: |
        # Detect OS suffix for header file
        if [ "${{ runner.os }}" == "Linux" ]; then OS_SUFFIX="linux"; fi
        if [ "${{ runner.os }}" == "Windows" ]; then OS_SUFFIX="win"; fi
        if [ "${{ runner.os }}" == "macOS" ]; then OS_SUFFIX="mac"; fi
        
        # Extract version using Python (pass filename as argument to avoid shell escaping issues)
        CEF_VER=$(python -c "import re, sys; print(re.search(r'#define CEF_VERSION \"([^\"]+)\"', open(sys.argv[1]).read()).group(1))" "src/version/cef_version_${OS_SUFFIX}.h")
        echo "Detected CEF Version: $CEF_VER"
        
        URL_BASE="https://cef-builds.spotifycdn.com"
        mkdir build
        cd build
        
        dl_and_extract() {
          local archive="cef_binary_${CEF_VER}_$1.tar.bz2"
          echo "Downloading $archive from $URL_BASE..."
          rm -f "$archive"
          
          # Try curl first, fallback to wget enforcing output filename
          if ! curl -f -L -o "$archive" "$URL_BASE/$archive"; then
             echo "curl failed, trying wget..."
             rm -f "$archive"
             wget -O "$archive" "$URL_BASE/$archive"
          fi
          
          echo "Extracting $archive..."
          tar -xjf "$archive"
        }

        if [ "${{ runner.os }}" == "Linux" ]; then
          dl_and_extract "linux32"
          dl_and_extract "linux64"
        elif [ "${{ runner.os }}" == "Windows" ]; then
          dl_and_extract "windows32"
          dl_and_extract "windows64"
        elif [ "${{ runner.os }}" == "macOS" ]; then
          dl_and_extract "macosx64"
        fi
        ls -l

    - name: Build package
      shell: bash
      run: |
        # Strip 'v' prefix from tag if present (e.g. v0.1 -> 0.1)
        VERSION=${GITHUB_REF_NAME#v}
        echo "Building version $VERSION"
        
        # Force GTK flags for Linux build manually to help CMake find headers
        if [ "${{ runner.os }}" == "Linux" ]; then
           export CFLAGS="$(pkg-config --cflags gtk+-2.0) -Wno-error"
           export CXXFLAGS="$(pkg-config --cflags gtk+-2.0) -Wno-error"
           echo "Forcing CFLAGS: $CFLAGS"
        fi
        
        python tools/build_distrib.py $VERSION --allow-partial

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions-${{ matrix.os }}
        path: build/distrib/*
        if-no-files-found: error

  publish:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Create dist directory
      run: mkdir dist

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist
        merge-multiple: true
        pattern: python-package-distributions-*

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: dist/*

    - name: Publish package
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        packages_dir: dist/
